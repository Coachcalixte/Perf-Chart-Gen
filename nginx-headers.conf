# Nginx Configuration for iframe Embedding Support
# Use this file if Coolify's default configuration doesn't allow iframe embedding
#
# This configuration allows the Streamlit app to be embedded in iframes
# from specific WordPress domains
#
# HOW TO USE WITH COOLIFY:
# 1. In Coolify dashboard, go to your application settings
# 2. Find "Custom Nginx Configuration" or "Advanced" section
# 3. Paste the content below into the custom configuration field
# 4. Update the ALLOWED_DOMAINS with your actual WordPress domain(s)
# 5. Save and redeploy

# === CUSTOM HEADERS FOR IFRAME EMBEDDING ===

# Allow embedding from specific domains
# Replace with your WordPress domain(s)
# Multiple domains: separate with spaces
add_header X-Frame-Options "ALLOW-FROM https://wordpress.hanstack.win https://refsc.local" always;

# Content Security Policy - allows iframe embedding from specified domains
# IMPORTANT: Update this with your WordPress domain(s)
add_header Content-Security-Policy "frame-ancestors 'self' https://wordpress.hanstack.win http://refsc.local https://*.hanstack.win" always;

# CORS headers for cross-origin requests
add_header Access-Control-Allow-Origin "*" always;
add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept" always;

# Prevent MIME type sniffing
add_header X-Content-Type-Options "nosniff" always;

# Enable XSS protection
add_header X-XSS-Protection "1; mode=block" always;

# Referrer policy
add_header Referrer-Policy "no-referrer-when-downgrade" always;

# === ALTERNATIVE: ALLOW ALL DOMAINS (LESS SECURE) ===
# If you want to allow iframe embedding from ANY domain, uncomment below
# and comment out the X-Frame-Options and Content-Security-Policy above
#
# add_header X-Frame-Options "ALLOWALL" always;
# add_header Content-Security-Policy "frame-ancestors *" always;

# === PROXY SETTINGS FOR STREAMLIT ===

# WebSocket support for Streamlit
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection "upgrade";

# Preserve original request information
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;

# Increase timeouts for long-running Streamlit operations
proxy_connect_timeout 300s;
proxy_send_timeout 300s;
proxy_read_timeout 300s;

# Buffering settings
proxy_buffering off;
proxy_request_buffering off;

# === NOTES ===
#
# 1. X-Frame-Options: Controls which domains can embed this page in an iframe
#    - ALLOW-FROM: Specific domain(s) only
#    - SAMEORIGIN: Only same domain
#    - DENY: No iframes allowed
#
# 2. Content-Security-Policy frame-ancestors: Modern replacement for X-Frame-Options
#    - 'self': Same domain
#    - specific domains: https://example.com
#    - *: All domains (not recommended for production)
#
# 3. For multiple WordPress domains, add them all:
#    add_header X-Frame-Options "ALLOW-FROM https://domain1.com https://domain2.com" always;
#    add_header Content-Security-Policy "frame-ancestors 'self' https://domain1.com https://domain2.com" always;
